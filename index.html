<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpreadGenie Pro - Elite Sports Betting Analytics</title>
    <style>
        /* CORE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding-bottom: 4rem;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* HEADER */
        header { background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f0f0f0; }
        .logo { 
            display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: bold; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        /* HERO & FILTER BAR */
        .hero { 
            text-align: center; 
            padding: 4rem 0 1rem; 
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        #lastUpdated { font-size: 1rem; opacity: 0.8; }
        
        /* UI BUTTONS & FILTERS */
        #confidenceFilterBar {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 1.25rem 0;
            flex-wrap: wrap; 
        }
        .filter-btn {
            border: 2px solid transparent;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            background: #e5e7eb; 
            color: #4b5563;
        }
        .filter-btn:hover { border-color: #93c5fd; }

        .filter-btn.active {
            box-shadow: 0 4px 8px rgba(102, 114, 234, 0.3);
            color: white; 
            border-color: transparent;
            transform: translateY(-1px);
        }

        /* Confidence Tier Colors for Filters/Badges */
        .conf-lock, .filter-btn.active.conf-lock { background: #10b981; } /* Green */
        .conf-strong, .filter-btn.active.conf-strong { background: #3b82f6; } /* Blue */
        .conf-lean, .filter-btn.active.conf-lean { background: #f59e0b; } /* Amber */
        .conf-pass, .filter-btn.active.conf-pass { background: #6b7280; } /* Gray */

        .confidence-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* GAME CARDS */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding-top: 20px;
        }
        .game-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: transform 0.3s;
        }
        .card-header {
            padding: 1.25rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .matchup-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 5px;
        }
        .game-meta {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            gap: 10px;
        }
        .sport-tag { 
            font-weight: 700;
            color: #667eea;
        }

        /* CARD BODY & PICK ROW */
        .card-body { padding: 1.25rem; }
        .pick-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 1rem;
        }
        .pick-label { font-weight: 600; color: #4b5563; }
        .pick-value { font-size: 1.1rem; font-weight: 700; color: #10b981; }

        /* ANALYSIS CONTENT */
        .analysis-content { position: relative; }
        .analysis-preview {
            max-height: 80px;
            overflow: hidden;
            color: #4b5563;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            white-space: normal;
        }
        .analysis-full {
            display: none;
            color: #4b5563;
            line-height: 1.6;
        }
        .read-more-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            padding: 0;
            text-decoration: underline;
        }
        
        /* LOGIN OVERLAY */
        #passwordOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }
        #passwordOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        .login-box h2 { color: #667eea; margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;
        }
        .login-box button {
            background: #667eea; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s;
        }
        .login-box button:hover { background: #5a66d0; }
        #passwordError { color: #ef4444; margin-top: 10px; display: none; font-size: 0.9rem; }

        #mainContent {
            opacity: 0;
            transition: opacity 0.5s 0.3s;
        }
        #mainContent.visible {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="passwordOverlay">
        <div class="login-box">
            <h2>Welcome to SpreadGenie Pro</h2>
            <p>Access requires authentication.</p>
            <input type="password" id="passwordInput" placeholder="Enter Access Code">
            <button onclick="checkPassword()">Access Analytics</button>
            <div id="passwordError">Incorrect access code. Please try again.</div>
        </div>
    </div>

    <div id="mainContent">
        <header>
            <div class="container">
                <nav>
                    <div class="logo">
                        üéØ SpreadGenie Pro <span style="font-size:0.8rem; font-weight: normal; color:#667eea;">V8.4</span>
                    </div>
                </nav>
            </div>
        </header>

        <main class="container">
            <div class="hero">
                <h1>Live Betting Intelligence</h1>
                <p id="lastUpdated">Syncing feed...</p>
            </div>
            
            <div id="confidenceFilterBar">
                <button class="filter-btn active" onclick="filterConfidence('ALL', this)">All Picks</button>
                <button class="filter-btn conf-lock" onclick="filterConfidence('LOCK', this)">üëë LOCK</button>
                <button class="filter-btn conf-strong" onclick="filterConfidence('STRONG', this)">üî• STRONG</button>
                <button class="filter-btn conf-lean" onclick="filterConfidence('LEAN', this)">üí° LEAN</button>
                <button class="filter-btn conf-pass" onclick="filterConfidence('PASS', this)">‚ûñ PASS</button>
            </div>
            <div id="predictionsContainer" class="grid-container"></div>

            <div id="noData" class="hidden" style="text-align: center; padding: 3rem; color: white;">
                <h2>No active predictions found for this filter.</h2>
                <p>Try resetting the filter or check back later.</p>
            </div>
            
        </main>
    </div>

<script>
    // --- V8.4 GLOBAL CONFIGURATION ---
    const PASSWORD = "Mirlou1210!";
    const DATA_URL = "./data/predictions.json"; // This is the file written by 06_github_publish.py
    let allPredictions = [];
    let currentLeague = "ALL";
    let currentConfidence = "ALL"; 
    
    // --- AUTH LOGIC ---
    function checkPassword() {
        if (document.getElementById('passwordInput').value === PASSWORD) {
            document.cookie = "sg_auth=true; max-age=604800; path=/"; 
            initApp();
        } else {
            document.getElementById('passwordError').style.display = 'block';
        }
    }

    function initApp() {
        document.getElementById('passwordOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.add('visible');
        // CRITICAL: Start fetching data immediately after successful authentication
        fetchData(); 
    }

    // --- V8.4 CORE DATA FETCH LOGIC (RESILIENT) ---
    async function fetchData() {
        const container = document.getElementById('predictionsContainer');
        const statusElement = document.getElementById('lastUpdated');
        
        container.innerHTML = '<div style="text-align: center; padding: 4rem;"><h2>Loading V8.4 Engine...</h2></div>'; 

        try {
            // Add cache-busting parameter to ensure fresh data after deployment
            const response = await fetch(`${DATA_URL}?t=${Date.now()}`);

            if (!response.ok) {
                statusElement.innerText = `Error: Could not fetch predictions (${response.status}).`;
                container.innerHTML = `<h2>No predictions published yet. Deployment error.</h2>`;
                allPredictions = [];
                return;
            }

            const data = await response.json();
            
            if (data && data.length > 0) {
                // SUCCESS: Filter DRAFTs and apply initial filters
                allPredictions = data.filter(p => p.status === "PUBLISH").reverse();
                applyFilters(); // Apply filters which calls renderCards
                statusElement.innerText = `Feed Synced: ${new Date().toLocaleTimeString()}`;
            } else {
                statusElement.innerText = 'Feed Synced: No active picks.';
                container.innerHTML = '<h2>No active picks right now. Check back soon.</h2>';
                allPredictions = [];
            }

        } catch (error) {
            console.error("Critical Error loading predictions:", error);
            statusElement.innerText = 'Feed Error. Check console.';
            container.innerHTML = `<h2>Critical Error: Failed to load data.</h2>`;
            allPredictions = [];
        }
    }
    
    // --- V8.4 RENDER LOGIC ---

    function renderCards(items) {
        const container = document.getElementById('predictionsContainer');
        container.innerHTML = "";
        
        if (items.length === 0) {
            document.getElementById('noData').classList.remove('hidden');
            return;
        }
        document.getElementById('noData').classList.add('hidden');

        items.forEach(pred => {
            // Read clean fields from 05_ai_predictor.py
            const selection = pred.selection || 'See Details';
            const confidenceTier = pred.confidence_tier || 'PASS'; 
            
            // Map the Tier to a visual class and value
            let confidenceVal = 0; 
            let tierClass = "conf-pass";
            
            if (confidenceTier.toUpperCase().includes('LOCK')) { confidenceVal = 85; tierClass = "conf-lock"; }
            else if (confidenceTier.toUpperCase().includes('STRONG')) { confidenceVal = 75; tierClass = "conf-strong"; }
            else if (confidenceTier.toUpperCase().includes('LEAN')) { confidenceVal = 65; tierClass = "conf-lean"; }

            // Format Analysis: Remove metadata headers from the analysis text
            let analysisBody = pred.analysis
                .replace(/‚ïê‚ïê‚ïê‚ïê.*?\n/g, '') 
                .replace(/## \d\. THE PICK.*?\n/gs, '') // Remove the pick section entirely to avoid duplication
                .replace(/## \d\. THE CALL.*?\n/gs, '') // Remove the call section entirely 
                .replace(/## \d\. .*?\n/g, '<strong>') 
                .replace(/‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ.*?\n/g, '') 
                .replace(/Selection:.*?\n/i, '')
                .replace(/Confidence:.*?\n/i, '')
                .replace(/Analysis:.*?\n/i, '') 
                .trim()
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>'); 
            
            const sport = pred.sport || detectSport(pred.game) || "NFL";

            const card = document.createElement('div');
            card.className = 'game-card';
            card.setAttribute('data-confidence-tier', confidenceTier.toUpperCase());
            card.setAttribute('data-confidence', confidenceVal); 

            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="game-meta">
                            <span class="sport-tag">${sport}</span>
                            <span>${formatDate(pred.date)}</span>
                        </div>
                        <div class="matchup-title">${pred.game}</div>
                    </div>
                    <span class="confidence-badge ${tierClass}">${confidenceTier}</span>
                </div>
                <div class="card-body">
                    <div class="pick-row">
                        <span class="pick-label">Target</span>
                        <span class="pick-value" style="color:#667eea">${selection}</span>
                    </div>
                    
                    <div class="analysis-content">
                        <div class="analysis-preview">
                            ${analysisBody}
                        </div>
                        <div class="analysis-full" style="display:none;">
                            ${analysisBody}
                        </div>
                        <button class="read-more-btn" onclick="toggleAnalysis(this)">Read Analysis ‚Üì</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    // --- HELPER FUNCTIONS (Simplified and Cleaned) ---
    
    function toggleAnalysis(btn) {
        const container = btn.closest('.analysis-content');
        const full = container.querySelector('.analysis-full');
        const preview = container.querySelector('.analysis-preview');
        
        if (full.style.display === 'block') {
            full.style.display = 'none';
            preview.style.display = '-webkit-box'; 
            btn.innerText = 'Read Analysis ‚Üì';
        } else {
            full.style.display = 'block';
            preview.style.display = 'none';
            btn.innerText = 'Hide Analysis ‚Üë';
        }
    }

    function formatDate(dateStr) {
        try {
            return new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        } catch { 
            return dateStr; 
        }
    }

    function detectSport(gameTitle) {
        // Simple logic for category filtering
        if (gameTitle.includes("Cowboys") || gameTitle.includes("Chiefs") || gameTitle.includes("Lions")) return "NFL";
        if (gameTitle.includes("Lakers") || gameTitle.includes("Celtics")) return "NBA";
        return "NFL";
    }

    function filterLeague(league) {
        currentLeague = league;
        document.querySelectorAll('.league-btn').forEach(btn => {
            if (btn.innerText === (league === "ALL" ? "All Sports" : league)) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        applyFilters();
    }

    function filterConfidence(tier, btnElement) {
        currentConfidence = tier;
        document.querySelectorAll('#confidenceFilterBar .filter-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        const filtered = allPredictions.filter(p => {
            const sport = detectSport(p.game) || "NFL";
            const cardConfidence = p.confidence_tier ? p.confidence_tier.toUpperCase() : 'PASS';
            
            // 1. League Filter
            const matchesLeague = currentLeague === "ALL" || sport === currentLeague;
            
            // 2. Search Filter
            const matchesSearch = p.game.toLowerCase().includes(search);
            
            // 3. Confidence Filter
            const matchesConfidence = currentConfidence === "ALL" || cardConfidence === currentConfidence;
            
            return matchesLeague && matchesSearch && matchesConfidence;
        });
        renderCards(filtered);
    }
    
    // --- V8.4 INITIALIZATION ---

    // 1. Check for valid cookie and call initApp (which calls fetchData)
    if (document.cookie.includes("sg_auth=true")) {
        initApp();
    } else {
        // 2. If no cookie, simply call fetchData once the DOM is ready (shows loading screen immediately)
        document.addEventListener('DOMContentLoaded', fetchData);
    }
</script>
</body>
</html>
